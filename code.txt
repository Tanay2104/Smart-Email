.
├── build_index.py
├── code.txt
├── config
│   ├── config.yml
│   └── domains.yml
├── data
│   ├── embeddings.faiss
│   ├── maildir
│   │   ├── gmail
│   │   │   ├── Drafts
│   │   │   │   ├── cur
│   │   │   │   ├── new
│   │   │   │   └── tmp
│   │   │   └── INBOX
│   │   │       ├── cur
│   │   │       │   ├── 1764160408.294241_4423.archlinux,U=4378:2,S
│   │   │       │   ├── 1764160408.294241_4429.archlinux,U=4384:2,S
│   │   │       │   ├── 1764160408.294241_4431.archlinux,U=4386:2,S
│   │   │       │   ├── 1764160408.294241_4432.archlinux,U=4387:2,S
│   │   │       │   ├── 1764160408.294241_4434.archlinux,U=4389:2,S
│   │   │       │   ├── 1764160408.294241_4435.archlinux,U=4390:2,S
│   │   │       │   ├── 1764160408.294241_4436.archlinux,U=4391:2,S
│   │   │       │   ├── 1764160408.294241_4437.archlinux,U=4392:2,S
│   │   │       │   ├── 1764160408.294241_4438.archlinux,U=4393:2,S
│   │   │       │   ├── 1764160408.294241_4439.archlinux,U=4394:2,S
│   │   │       │   ├── 1764160408.294241_4440.archlinux,U=4395:2,S
│   │   │       │   ├── 1764160408.294241_4441.archlinux,U=4396:2,S
│   │   │       │   ├── 1764160408.294241_4442.archlinux,U=4397:2,S
│   │   │       │   ├── 1764160408.294241_4445.archlinux,U=4400:2,S
│   │   │       │   ├── 1764160408.294241_4446.archlinux,U=4401:2,S
│   │   │       │   ├── 1764160409.294241_4453.archlinux,U=4408:2,S
│   │   │       │   ├── 1764160409.294241_4455.archlinux,U=4410:2,S
│   │   │       │   ├── 1764160409.294241_4456.archlinux,U=4411:2,S
│   │   │       │   ├── 1764160409.294241_4457.archlinux,U=4412:2,S
│   │   │       │   ├── 1764160409.294241_4458.archlinux,U=4413:2,S
│   │   │       │   ├── 1764160409.294241_4459.archlinux,U=4414:2,S
│   │   │       │   ├── 1764160409.294241_4460.archlinux,U=4415:2,S
│   │   │       │   ├── 1764160409.294241_4461.archlinux,U=4416:2,S
│   │   │       │   ├── 1764160409.294241_4463.archlinux,U=4418:2,S
│   │   │       │   ├── 1764160409.294241_4464.archlinux,U=4419:2,S
│   │   │       │   ├── 1764160409.294241_4465.archlinux,U=4420:2,S
│   │   │       │   ├── 1764160409.294241_4471.archlinux,U=4426:2,S
│   │   │       │   ├── 1764160409.294241_4475.archlinux,U=4430:2,S
│   │   │       │   ├── 1764160409.294241_4477.archlinux,U=4432:2,S
│   │   │       │   ├── 1764160409.294241_4479.archlinux,U=4434:2,S
│   │   │       │   ├── 1764160409.294241_4483.archlinux,U=4438:2,S
│   │   │       │   ├── 1764160409.294241_4488.archlinux,U=4443:2,S
│   │   │       │   ├── 1764160409.294241_4490.archlinux,U=4445:2,S
│   │   │       │   ├── 1764160409.294241_4491.archlinux,U=4446:2,S
│   │   │       │   ├── 1764160409.294241_4492.archlinux,U=4447:2,S
│   │   │       │   ├── 1764160409.294241_4493.archlinux,U=4448:2,S
│   │   │       │   ├── 1764160409.294241_4494.archlinux,U=4449:2,S
│   │   │       │   ├── 1764160409.294241_4495.archlinux,U=4450:2,S
│   │   │       │   ├── 1764160410.294241_4496.archlinux,U=4451:2,S
│   │   │       │   ├── 1764160410.294241_4497.archlinux,U=4452:2,S
│   │   │       │   ├── 1764160410.294241_4498.archlinux,U=4453:2,S
│   │   │       │   ├── 1764160410.294241_4499.archlinux,U=4454:2,S
│   │   │       │   ├── 1764160410.294241_4500.archlinux,U=4455:2,S
│   │   │       │   ├── 1764160410.294241_4501.archlinux,U=4456:2,S
│   │   │       │   ├── 1764160410.294241_4502.archlinux,U=4457:2,S
│   │   │       │   ├── 1764160410.294241_4503.archlinux,U=4458:2,S
│   │   │       │   ├── 1764160410.294241_4504.archlinux,U=4459:2,S
│   │   │       │   ├── 1764160410.294241_4505.archlinux,U=4460:2,S
│   │   │       │   ├── 1764160410.294241_4506.archlinux,U=4461:2,S
│   │   │       │   ├── 1764160410.294241_4507.archlinux,U=4462:2,S
│   │   │       │   ├── 1764160410.294241_4508.archlinux,U=4463:2,S
│   │   │       │   ├── 1764160410.294241_4509.archlinux,U=4464:2,S
│   │   │       │   ├── 1764160410.294241_4511.archlinux,U=4466:2,S
│   │   │       │   ├── 1764160410.294241_4512.archlinux,U=4467:2,S
│   │   │       │   ├── 1764160410.294241_4513.archlinux,U=4468:2,S
│   │   │       │   ├── 1764160410.294241_4514.archlinux,U=4469:2,S
│   │   │       │   ├── 1764160410.294241_4515.archlinux,U=4470:2,S
│   │   │       │   ├── 1764160410.294241_4516.archlinux,U=4471:2,S
│   │   │       │   ├── 1764160410.294241_4517.archlinux,U=4472:2,S
│   │   │       │   ├── 1764160410.294241_4518.archlinux,U=4473:2,S
│   │   │       │   ├── 1764160410.294241_4532.archlinux,U=4487:2,S
│   │   │       │   ├── 1764160410.294241_4534.archlinux,U=4489:2,S
│   │   │       │   ├── 1764160410.294241_4535.archlinux,U=4490:2,S
│   │   │       │   ├── 1764160411.294241_4537.archlinux,U=4492:2,S
│   │   │       │   ├── 1764160411.294241_4543.archlinux,U=4498:2,S
│   │   │       │   ├── 1764160411.294241_4545.archlinux,U=4500:2,S
│   │   │       │   ├── 1764160411.294241_4549.archlinux,U=4504:2,S
│   │   │       │   ├── 1764160411.294241_4556.archlinux,U=4511:2,S
│   │   │       │   ├── 1764160411.294241_4577.archlinux,U=4532:2,S
│   │   │       │   ├── 1764160411.294241_4580.archlinux,U=4535:2,S
│   │   │       │   ├── 1764160412.294241_4590.archlinux,U=4545:2,S
│   │   │       │   ├── 1764160412.294241_4591.archlinux,U=4546:2,S
│   │   │       │   ├── 1764160412.294241_4595.archlinux,U=4550:2,S
│   │   │       │   ├── 1764160412.294241_4596.archlinux,U=4551:2,S
│   │   │       │   ├── 1764160412.294241_4599.archlinux,U=4554:2,S
│   │   │       │   ├── 1764160412.294241_4602.archlinux,U=4557:2,S
│   │   │       │   ├── 1764160412.294241_4613.archlinux,U=4568:2,S
│   │   │       │   ├── 1764160412.294241_4615.archlinux,U=4570:2,S
│   │   │       │   ├── 1764160412.294241_4617.archlinux,U=4572:2,S
│   │   │       │   └── 1764160412.294241_4618.archlinux,U=4573:2,S
│   │   │       ├── new
│   │   │       │   ├── 1764160408.294241_4422.archlinux,U=4377:2,
│   │   │       │   ├── 1764160408.294241_4424.archlinux,U=4379:2,
│   │   │       │   ├── 1764160408.294241_4425.archlinux,U=4380:2,
│   │   │       │   ├── 1764160408.294241_4426.archlinux,U=4381:2,
│   │   │       │   ├── 1764160408.294241_4427.archlinux,U=4382:2,
│   │   │       │   ├── 1764160408.294241_4428.archlinux,U=4383:2,
│   │   │       │   ├── 1764160408.294241_4430.archlinux,U=4385:2,
│   │   │       │   ├── 1764160408.294241_4433.archlinux,U=4388:2,
│   │   │       │   ├── 1764160408.294241_4443.archlinux,U=4398:2,
│   │   │       │   ├── 1764160408.294241_4444.archlinux,U=4399:2,
│   │   │       │   ├── 1764160408.294241_4447.archlinux,U=4402:2,
│   │   │       │   ├── 1764160408.294241_4448.archlinux,U=4403:2,
│   │   │       │   ├── 1764160408.294241_4449.archlinux,U=4404:2,
│   │   │       │   ├── 1764160408.294241_4450.archlinux,U=4405:2,
│   │   │       │   ├── 1764160408.294241_4451.archlinux,U=4406:2,
│   │   │       │   ├── 1764160408.294241_4452.archlinux,U=4407:2,
│   │   │       │   ├── 1764160409.294241_4454.archlinux,U=4409:2,
│   │   │       │   ├── 1764160409.294241_4462.archlinux,U=4417:2,
│   │   │       │   ├── 1764160409.294241_4466.archlinux,U=4421:2,
│   │   │       │   ├── 1764160409.294241_4467.archlinux,U=4422:2,
│   │   │       │   ├── 1764160409.294241_4468.archlinux,U=4423:2,
│   │   │       │   ├── 1764160409.294241_4469.archlinux,U=4424:2,
│   │   │       │   ├── 1764160409.294241_4470.archlinux,U=4425:2,
│   │   │       │   ├── 1764160409.294241_4472.archlinux,U=4427:2,
│   │   │       │   ├── 1764160409.294241_4473.archlinux,U=4428:2,
│   │   │       │   ├── 1764160409.294241_4474.archlinux,U=4429:2,
│   │   │       │   ├── 1764160409.294241_4476.archlinux,U=4431:2,
│   │   │       │   ├── 1764160409.294241_4478.archlinux,U=4433:2,
│   │   │       │   ├── 1764160409.294241_4480.archlinux,U=4435:2,
│   │   │       │   ├── 1764160409.294241_4481.archlinux,U=4436:2,
│   │   │       │   ├── 1764160409.294241_4482.archlinux,U=4437:2,
│   │   │       │   ├── 1764160409.294241_4484.archlinux,U=4439:2,
│   │   │       │   ├── 1764160409.294241_4485.archlinux,U=4440:2,
│   │   │       │   ├── 1764160409.294241_4486.archlinux,U=4441:2,
│   │   │       │   ├── 1764160409.294241_4487.archlinux,U=4442:2,
│   │   │       │   ├── 1764160409.294241_4489.archlinux,U=4444:2,
│   │   │       │   ├── 1764160410.294241_4510.archlinux,U=4465:2,
│   │   │       │   ├── 1764160410.294241_4519.archlinux,U=4474:2,
│   │   │       │   ├── 1764160410.294241_4520.archlinux,U=4475:2,
│   │   │       │   ├── 1764160410.294241_4521.archlinux,U=4476:2,
│   │   │       │   ├── 1764160410.294241_4522.archlinux,U=4477:2,
│   │   │       │   ├── 1764160410.294241_4523.archlinux,U=4478:2,
│   │   │       │   ├── 1764160410.294241_4524.archlinux,U=4479:2,
│   │   │       │   ├── 1764160410.294241_4525.archlinux,U=4480:2,
│   │   │       │   ├── 1764160410.294241_4526.archlinux,U=4481:2,
│   │   │       │   ├── 1764160410.294241_4527.archlinux,U=4482:2,
│   │   │       │   ├── 1764160410.294241_4528.archlinux,U=4483:2,
│   │   │       │   ├── 1764160410.294241_4529.archlinux,U=4484:2,
│   │   │       │   ├── 1764160410.294241_4530.archlinux,U=4485:2,
│   │   │       │   ├── 1764160410.294241_4531.archlinux,U=4486:2,
│   │   │       │   ├── 1764160410.294241_4533.archlinux,U=4488:2,
│   │   │       │   ├── 1764160410.294241_4536.archlinux,U=4491:2,
│   │   │       │   ├── 1764160411.294241_4538.archlinux,U=4493:2,
│   │   │       │   ├── 1764160411.294241_4539.archlinux,U=4494:2,
│   │   │       │   ├── 1764160411.294241_4540.archlinux,U=4495:2,
│   │   │       │   ├── 1764160411.294241_4541.archlinux,U=4496:2,
│   │   │       │   ├── 1764160411.294241_4542.archlinux,U=4497:2,
│   │   │       │   ├── 1764160411.294241_4544.archlinux,U=4499:2,
│   │   │       │   ├── 1764160411.294241_4546.archlinux,U=4501:2,
│   │   │       │   ├── 1764160411.294241_4547.archlinux,U=4502:2,
│   │   │       │   ├── 1764160411.294241_4548.archlinux,U=4503:2,
│   │   │       │   ├── 1764160411.294241_4550.archlinux,U=4505:2,
│   │   │       │   ├── 1764160411.294241_4551.archlinux,U=4506:2,
│   │   │       │   ├── 1764160411.294241_4552.archlinux,U=4507:2,
│   │   │       │   ├── 1764160411.294241_4553.archlinux,U=4508:2,
│   │   │       │   ├── 1764160411.294241_4554.archlinux,U=4509:2,
│   │   │       │   ├── 1764160411.294241_4555.archlinux,U=4510:2,
│   │   │       │   ├── 1764160411.294241_4557.archlinux,U=4512:2,
│   │   │       │   ├── 1764160411.294241_4558.archlinux,U=4513:2,
│   │   │       │   ├── 1764160411.294241_4559.archlinux,U=4514:2,
│   │   │       │   ├── 1764160411.294241_4560.archlinux,U=4515:2,
│   │   │       │   ├── 1764160411.294241_4561.archlinux,U=4516:2,
│   │   │       │   ├── 1764160411.294241_4562.archlinux,U=4517:2,
│   │   │       │   ├── 1764160411.294241_4563.archlinux,U=4518:2,
│   │   │       │   ├── 1764160411.294241_4564.archlinux,U=4519:2,
│   │   │       │   ├── 1764160411.294241_4565.archlinux,U=4520:2,
│   │   │       │   ├── 1764160411.294241_4566.archlinux,U=4521:2,
│   │   │       │   ├── 1764160411.294241_4567.archlinux,U=4522:2,
│   │   │       │   ├── 1764160411.294241_4568.archlinux,U=4523:2,
│   │   │       │   ├── 1764160411.294241_4569.archlinux,U=4524:2,
│   │   │       │   ├── 1764160411.294241_4570.archlinux,U=4525:2,
│   │   │       │   ├── 1764160411.294241_4571.archlinux,U=4526:2,
│   │   │       │   ├── 1764160411.294241_4572.archlinux,U=4527:2,
│   │   │       │   ├── 1764160411.294241_4573.archlinux,U=4528:2,
│   │   │       │   ├── 1764160411.294241_4574.archlinux,U=4529:2,
│   │   │       │   ├── 1764160411.294241_4575.archlinux,U=4530:2,
│   │   │       │   ├── 1764160411.294241_4576.archlinux,U=4531:2,
│   │   │       │   ├── 1764160411.294241_4578.archlinux,U=4533:2,
│   │   │       │   ├── 1764160411.294241_4579.archlinux,U=4534:2,
│   │   │       │   ├── 1764160411.294241_4581.archlinux,U=4536:2,
│   │   │       │   ├── 1764160411.294241_4582.archlinux,U=4537:2,
│   │   │       │   ├── 1764160411.294241_4583.archlinux,U=4538:2,
│   │   │       │   ├── 1764160411.294241_4584.archlinux,U=4539:2,
│   │   │       │   ├── 1764160411.294241_4585.archlinux,U=4540:2,
│   │   │       │   ├── 1764160411.294241_4586.archlinux,U=4541:2,
│   │   │       │   ├── 1764160411.294241_4587.archlinux,U=4542:2,
│   │   │       │   ├── 1764160411.294241_4588.archlinux,U=4543:2,
│   │   │       │   ├── 1764160412.294241_4589.archlinux,U=4544:2,
│   │   │       │   ├── 1764160412.294241_4592.archlinux,U=4547:2,
│   │   │       │   ├── 1764160412.294241_4593.archlinux,U=4548:2,
│   │   │       │   ├── 1764160412.294241_4594.archlinux,U=4549:2,
│   │   │       │   ├── 1764160412.294241_4597.archlinux,U=4552:2,
│   │   │       │   ├── 1764160412.294241_4598.archlinux,U=4553:2,
│   │   │       │   ├── 1764160412.294241_4600.archlinux,U=4555:2,
│   │   │       │   ├── 1764160412.294241_4601.archlinux,U=4556:2,
│   │   │       │   ├── 1764160412.294241_4603.archlinux,U=4558:2,
│   │   │       │   ├── 1764160412.294241_4604.archlinux,U=4559:2,
│   │   │       │   ├── 1764160412.294241_4605.archlinux,U=4560:2,
│   │   │       │   ├── 1764160412.294241_4606.archlinux,U=4561:2,
│   │   │       │   ├── 1764160412.294241_4607.archlinux,U=4562:2,
│   │   │       │   ├── 1764160412.294241_4608.archlinux,U=4563:2,
│   │   │       │   ├── 1764160412.294241_4609.archlinux,U=4564:2,
│   │   │       │   ├── 1764160412.294241_4610.archlinux,U=4565:2,
│   │   │       │   ├── 1764160412.294241_4611.archlinux,U=4566:2,
│   │   │       │   ├── 1764160412.294241_4612.archlinux,U=4567:2,
│   │   │       │   ├── 1764160412.294241_4614.archlinux,U=4569:2,
│   │   │       │   ├── 1764160412.294241_4616.archlinux,U=4571:2,
│   │   │       │   ├── 1764160412.294241_4619.archlinux,U=4574:2,
│   │   │       │   ├── 1764160412.294241_4620.archlinux,U=4575:2,
│   │   │       │   ├── 1764160412.294241_4621.archlinux,U=4576:2,
│   │   │       │   ├── 1764160412.294241_4622.archlinux,U=4577:2,
│   │   │       │   ├── 1764160413.294241_4623.archlinux,U=4578:2,
│   │   │       │   ├── 1764160413.294241_4624.archlinux,U=4579:2,
│   │   │       │   └── 1764160413.294241_4625.archlinux,U=4580:2,
│   │   │       └── tmp
│   │   └── iitb
│   │       ├── Archive
│   │       │   ├── cur
│   │       │   ├── new
│   │       │   └── tmp
│   │       ├── Drafts
│   │       │   ├── cur
│   │       │   ├── new
│   │       │   └── tmp
│   │       ├── INBOX
│   │       │   ├── cur
│   │       │   │   ├── 1764159780.293022_10.archlinux,U=10:2,S
│   │       │   │   ├── 1764159780.293022_11.archlinux,U=11:2,S
│   │       │   │   ├── 1764159780.293022_17.archlinux,U=17:2,S
│   │       │   │   ├── 1764159780.293022_28.archlinux,U=28:2,S
│   │       │   │   ├── 1764159780.293022_29.archlinux,U=29:2,S
│   │       │   │   ├── 1764159780.293022_2.archlinux,U=2:2,S
│   │       │   │   ├── 1764159780.293022_4.archlinux,U=4:2,S
│   │       │   │   ├── 1764159780.293022_6.archlinux,U=6:2,S
│   │       │   │   ├── 1764160048.294241_10.archlinux,U=41:2,S
│   │       │   │   ├── 1764160048.294241_11.archlinux,U=42:2,S
│   │       │   │   ├── 1764160048.294241_17.archlinux,U=48:2,S
│   │       │   │   ├── 1764160048.294241_28.archlinux,U=59:2,S
│   │       │   │   ├── 1764160048.294241_29.archlinux,U=60:2,S
│   │       │   │   ├── 1764160048.294241_2.archlinux,U=33:2,S
│   │       │   │   ├── 1764160048.294241_4.archlinux,U=35:2,S
│   │       │   │   └── 1764160048.294241_6.archlinux,U=37:2,S
│   │       │   ├── new
│   │       │   │   ├── 1764159780.293022_12.archlinux,U=12:2,
│   │       │   │   ├── 1764159780.293022_13.archlinux,U=13:2,
│   │       │   │   ├── 1764159780.293022_14.archlinux,U=14:2,
│   │       │   │   ├── 1764159780.293022_15.archlinux,U=15:2,
│   │       │   │   ├── 1764159780.293022_16.archlinux,U=16:2,
│   │       │   │   ├── 1764159780.293022_18.archlinux,U=18:2,
│   │       │   │   ├── 1764159780.293022_19.archlinux,U=19:2,
│   │       │   │   ├── 1764159780.293022_1.archlinux,U=1:2,
│   │       │   │   ├── 1764159780.293022_20.archlinux,U=20:2,
│   │       │   │   ├── 1764159780.293022_21.archlinux,U=21:2,
│   │       │   │   ├── 1764159780.293022_22.archlinux,U=22:2,
│   │       │   │   ├── 1764159780.293022_23.archlinux,U=23:2,
│   │       │   │   ├── 1764159780.293022_24.archlinux,U=24:2,
│   │       │   │   ├── 1764159780.293022_25.archlinux,U=25:2,
│   │       │   │   ├── 1764159780.293022_26.archlinux,U=26:2,
│   │       │   │   ├── 1764159780.293022_27.archlinux,U=27:2,
│   │       │   │   ├── 1764159780.293022_30.archlinux,U=30:2,
│   │       │   │   ├── 1764159780.293022_31.archlinux,U=31:2,
│   │       │   │   ├── 1764159780.293022_3.archlinux,U=3:2,
│   │       │   │   ├── 1764159780.293022_5.archlinux,U=5:2,
│   │       │   │   ├── 1764159780.293022_7.archlinux,U=7:2,
│   │       │   │   ├── 1764159780.293022_8.archlinux,U=8:2,
│   │       │   │   ├── 1764159780.293022_9.archlinux,U=9:2,
│   │       │   │   ├── 1764160048.294241_12.archlinux,U=43:2,
│   │       │   │   ├── 1764160048.294241_13.archlinux,U=44:2,
│   │       │   │   ├── 1764160048.294241_14.archlinux,U=45:2,
│   │       │   │   ├── 1764160048.294241_15.archlinux,U=46:2,
│   │       │   │   ├── 1764160048.294241_16.archlinux,U=47:2,
│   │       │   │   ├── 1764160048.294241_18.archlinux,U=49:2,
│   │       │   │   ├── 1764160048.294241_19.archlinux,U=50:2,
│   │       │   │   ├── 1764160048.294241_1.archlinux,U=32:2,
│   │       │   │   ├── 1764160048.294241_20.archlinux,U=51:2,
│   │       │   │   ├── 1764160048.294241_21.archlinux,U=52:2,
│   │       │   │   ├── 1764160048.294241_22.archlinux,U=53:2,
│   │       │   │   ├── 1764160048.294241_23.archlinux,U=54:2,
│   │       │   │   ├── 1764160048.294241_24.archlinux,U=55:2,
│   │       │   │   ├── 1764160048.294241_25.archlinux,U=56:2,
│   │       │   │   ├── 1764160048.294241_26.archlinux,U=57:2,
│   │       │   │   ├── 1764160048.294241_27.archlinux,U=58:2,
│   │       │   │   ├── 1764160048.294241_30.archlinux,U=61:2,
│   │       │   │   ├── 1764160048.294241_31.archlinux,U=62:2,
│   │       │   │   ├── 1764160048.294241_3.archlinux,U=34:2,
│   │       │   │   ├── 1764160048.294241_5.archlinux,U=36:2,
│   │       │   │   ├── 1764160048.294241_7.archlinux,U=38:2,
│   │       │   │   ├── 1764160048.294241_8.archlinux,U=39:2,
│   │       │   │   └── 1764160048.294241_9.archlinux,U=40:2,
│   │       │   └── tmp
│   │       ├── Junk
│   │       │   ├── cur
│   │       │   ├── new
│   │       │   └── tmp
│   │       ├── Sent
│   │       │   ├── cur
│   │       │   ├── new
│   │       │   └── tmp
│   │       └── Trash
│   │           ├── cur
│   │           ├── new
│   │           └── tmp
│   └── meta.sqlite
├── models
│   ├── embedding
│   │   └── bge-small-en-v1.5-f32.gguf
│   └── instruction
│       └── mistral-7b-instruct-v0.2.Q3_K_L.gguf
└── src
    ├── classify.py
    ├── cleanup.py
    ├── embed.py
    ├── faiss_helper.py
    ├── faiss.py
    ├── llama.py
    ├── main.py
    ├── parse.py
    ├── pipeline.py
    ├── __pycache__
    │   ├── classify.cpython-313.pyc
    │   ├── cleanup.cpython-313.pyc
    │   ├── embed.cpython-313.pyc
    │   ├── faiss_helper.cpython-313.pyc
    │   ├── llama.cpython-313.pyc
    │   ├── main.cpython-313.pyc
    │   ├── parse.cpython-313.pyc
    │   ├── pipeline.cpython-313.pyc
    │   └── score.cpython-313.pyc
    └── score.py

43 directories, 293 files
# build_index.py
import yaml
import sqlite3
import os
from src.llama import embed_text_with_llama
import faiss
import numpy as np

DOMAINS_YML = "config/domains.yml"
META_DB = "data/meta.sqlite"
INDEX_PATH = "data/embeddings.faiss"

def build_domain_index():
    with open(DOMAINS_YML) as f:
        cfg = yaml.safe_load(f)
    domains = cfg.get("domains", [])  # expect list of {"name":..., "description":...}
    if not domains:
        raise SystemExit("no domains defined in config/domains.yml")

    vectors = []
    for d in domains:
        text = d.get("description", d.get("name", ""))
        vec = embed_text_with_llama(text)
        vectors.append(np.array(vec, dtype="float32"))

    dim = vectors[0].shape[0]
    index = faiss.IndexFlatIP(dim)
    mat = np.stack(vectors, axis=0)
    faiss.normalize_L2(mat)  # optional normalization
    index.add(mat)

    os.makedirs(os.path.dirname(INDEX_PATH) or ".", exist_ok=True)
    faiss.write_index(index, INDEX_PATH)

    # write meta db with domains table (rowid corresponds to index order)
    os.makedirs(os.path.dirname(META_DB) or ".", exist_ok=True)
    conn = sqlite3.connect(META_DB)
    conn.execute("CREATE TABLE IF NOT EXISTS domains (name TEXT, description TEXT)")
    conn.execute("DELETE FROM domains")
    for d in domains:
        conn.execute("INSERT INTO domains (name, description) VALUES (?, ?)", (d.get("name"), d.get("description", "")))
    conn.commit()
    conn.close()
    print(f"Built FAISS index at {INDEX_PATH} and meta DB at {META_DB}")

if __name__ == "__main__":
    build_domain_index()
import yaml
import re
import os
from datetime import datetime, timezone

def rule_score(email):
    # Assigns weights to emails based on predecided values.
    domains = []
    # Safely try to load the config, fallback to empty if missing
    if os.path.exists("config/domains.yml"):
        try:
            with open("config/domains.yml") as f:
                data = yaml.safe_load(f)
                if data:
                    domains = data.get("important_domains", [])
        except Exception as e:
            print(f"Warning: could not load domains: {e}")

    s = 0.0

    # Domain score
    # Safe extraction of domain
    from_addr = email.get("from", "")
    if from_addr:
        try:
            domain = from_addr.split("@")[-1]
            if domain in domains:
                s += 0.4
        except IndexError:
            pass

    # Keyword score
    keywords = ["deadline", "submit", "submission", "assigment", "assignment", "offer", 
                "interview", "urgent", "slot", "due soon"]
    
    # FIX 1: Use correct key 'subject' (singular) and handle None
    subject = email.get("subject") or ""
    body = email.get("body") or ""
    text = f"{subject} {body}".lower()
    
    for kw in keywords:
        if kw in text:
            s += 0.15

    # Attachment score
    # FIX 2: Use .get() to avoid KeyError if key is missing
    for att in email.get("attachments", []):
        if att.endswith(".pdf"):
            s += 0.1

    # Recency score
    # FIX 3: Correct date math. (datetime - datetime) = timedelta
    date_obj = email.get("date")
    if date_obj and isinstance(date_obj, datetime):
        now = datetime.now(timezone.utc)
        if date_obj.tzinfo is None:
            date_obj = date_obj.replace(tzinfo = timezone.utc)
        delta = now - date_obj
        if delta.days <= 2:
            s += 0.2

    return min(s, 1.0)
# CLeanup file
import time
import email
import os
from email.parser import BytesParser
from email.utils import parsedate_to_datetime

# --- Configuration ---
MAIL_ROOT = os.path.expanduser("~/Projects/smart-mail/data/maildir")
DAYS_TO_KEEP = 20
DRY_RUN = False # Be careful!

def get_email_date(filepath):
    """Reads the email file and returns its Date header as a timestamp."""
    try:
        with open(filepath, 'rb') as f:
            # We only need the headers, so stop after headers
            parser = BytesParser()
            headers = parser.parse(f, headersonly=True)
            
            date_str = headers['Date']
            if not date_str:
                return os.path.getmtime(filepath) # Fallback
            
            # Parse date string to datetime object
            email_date = parsedate_to_datetime(date_str)
            return email_date.timestamp()
    except Exception as e:
        # If we can't read it, assume it's new to be safe
        return time.time() 

cutoff_time = time.time() - (DAYS_TO_KEEP * 86400)

def clean_folder(folder_path):
    deleted = 0
    for root, dirs, files in os.walk(folder_path):
        if os.path.basename(root) in ['cur', 'new']:
            for file in files:
                filepath = os.path.join(root, file)
                
                # Get true date from email header
                email_ts = get_email_date(filepath)
                
                if email_ts < cutoff_time:
                    if DRY_RUN:
                        print(f"[DRY RUN] Old email found: {filepath}")
                    else:
                        try:
                            os.remove(filepath)
                            deleted += 1
                            # print(f"Deleted: {file}") # Uncomment for verbose
                        except OSError:
                            pass
    return deleted

print(f"Cleaning emails older than {DAYS_TO_KEEP} days...")
for account in ["iitb", "gmail"]:
    path = os.path.join(MAIL_ROOT, account)
    if os.path.exists(path):
        count = clean_folder(path)
        print(f"[{account}] Deleted {count} emails.")

# src/embed.py
from .llama import embed_text_with_llama

def embed_text(text: str):
    # small pre/post processing can go here
    return embed_text_with_llama(text)
# src/faiss_helper.py
import faiss
import numpy as np
import sqlite3
import os

INDEX_PATH = os.path.expanduser(os.getenv("SMARTMAIL_FAISS", "~/projects/smart-mail/data/embeddings.faiss"))
META_DB = os.path.expanduser(os.getenv("SMARTMAIL_META_DB", "~/projects/smart-mail/data/meta.sqlite"))

class FaissHelper:
    def __init__(self):
        if not os.path.exists(INDEX_PATH):
            raise FileNotFoundError(f"FAISS index missing at {INDEX_PATH}")
        self.index = faiss.read_index(INDEX_PATH)
        if not os.path.exists(META_DB):
            raise FileNotFoundError(f"meta DB missing at {META_DB}")
        self.conn = sqlite3.connect(META_DB)

    def query(self, vec, k=3):
        arr = np.array(vec, dtype="float32").reshape(1, -1)
        if arr.shape[1] != self.index.d:
            raise ValueError(
                f"Dimension Error! \n"
                f"The FAISS index expects dimension: {self.index.d}\n"
                f"But the embedding model returned: {arr.shape[1]}\n"
                f"Fix: Delete 'data/embeddings.faiss' and rebuild the index, "
                f"or check your LLAMA_EMBED_MODEL."
            )
        D, I = self.index.search(arr, k)
        rows = []
        for idx, dist in zip(I[0], D[0]):
            if idx < 0:
                continue
            # rowid storage assumed to be 1-based
            cur = self.conn.execute("SELECT name, description FROM domains WHERE rowid = ?", (int(idx) + 1,))
            r = cur.fetchone()
            if r:
                rows.append({"name": r[0], "description": r[1], "score": float(dist)})
        return rows
import faiss
import sqlite3

def build_index(emails):
    dim = 384# TODO: this depends on model
    index = faiss.IndexFlatIP(dim)
    conn = sqlite3.connect("data/meta.sqlite")
    conn.execute("CREATE TABLE IF NOT EXISTS mails (path TEXT PRIMARY KEY, vector BLOB)")

    for e in emails:
        vec = embed_text(e["subject"] + " " + e["body"])
        index.add(vec.reshape(1, -1))
        conn.execute("INSERT OR REPLACE INTO mails VALUES (?, ?)", (e["path"], vec.tobytes()))
    conn.commit()
    faiss.write_index(index, "data/embeddings.faiss")

# src/llama.py (Fixed Version)
import subprocess
import os
import re
import yaml

CONFIG_PATH = os.path.expanduser("~/Projects/smart-mail/config/config.yml")

def load_config():
    if os.path.exists(CONFIG_PATH):
        with open(CONFIG_PATH, "r") as f:
            return yaml.safe_load(f)
    print(f"Warning: Config not found at {CONFIG_PATH}")
    return {}

# Load configuration once
cfg = load_config()
LLAMA_BIN = cfg.get("llama_bin", "~/llama.cpp/build/bin/llama-cli")
MODEL_PATH = cfg.get("llama_model", "~/Projects/smart-mail/models/instruction/mistral-7b-instruct-v0.2.Q3_K_L.gguf")
EMBED_BIN = cfg.get("embed_bin", "~/llama.cpp/build/bin/llama-embedding")
EMBED_MODEL = cfg.get("embed_model", "~/Projects/smart-mail/models/embedding/bge-small-en-v1.5-f32.gguf")

def call_llama(prompt: str, max_tokens: int = 256, temperature: float = 0.2, timeout: int = 30) -> str:
    binp = os.path.expanduser(LLAMA_BIN)
    modelp = os.path.expanduser(MODEL_PATH)
    cmd = [
        binp, "-m", modelp, "-p", prompt,
        "--temp", str(temperature), "--n_predict", str(max_tokens),
        "--repeat_penalty", "1.1"
    ]
    # Existing call_llama logic is fine, keep it as is...
    try:
        proc = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, check=False, timeout=timeout, text=False)
        stdout_text = proc.stdout.decode("utf-8", errors="replace").strip()
        stderr_text = proc.stderr.decode("utf-8", errors="replace").strip()
    except subprocess.TimeoutExpired:
        raise RuntimeError("llama.cpp invocation timed out")
    if proc.returncode != 0:
        raise RuntimeError(f"llama.cpp failed (rc={proc.returncode}): {stderr_text}")
    return stdout_text


def embed_text_with_llama(text: str, embed_bin: str = None, embed_model: str = None) -> list:
    if embed_bin is None:
        embed_bin =  EMBED_BIN
    if embed_model is None:
        embed_model = EMBED_MODEL

    embed_bin = os.path.expanduser(embed_bin)
    embed_model = os.path.expanduser(embed_model)
    # FIX: Sanitize text to prevent multiple embeddings
    # Replace newlines with spaces so the tool sees it as one single prompt
    text = text.replace("\n", " ").replace("\r", " ")
    MAX_CHARS = 512
    if len(text) > MAX_CHARS:
        text = text[:MAX_CHARS]

    cmd = [embed_bin, "-m", embed_model, "-c", "512", "-p", text]

    try:
        # FIX: Use text=False to prevent UnicodeDecodeError crashing the script
        proc = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=False, check=False)
        
        if proc.returncode != 0:
            stderr_text = proc.stderr.decode("utf-8", errors="replace")
            raise RuntimeError(f"Binary exited with error code {proc.returncode}.\nSTDERR: {stderr_text}")

        # Decode manually with replacement to handle bad bytes
        output = proc.stdout.decode("utf-8", errors="replace")
        
        # ROBUST PARSING STRATEGY (Concatenate all output first)
        # This handles cases where the vector wraps across multiple lines
        clean_output = output.replace("\n", " ").replace("\r", " ")
        
        # Regex to find "embedding <num>: <numbers...>"
        # Looks for 'embedding', an optional ID, a colon, and then a long string of numbers
        match = re.search(r"embedding(?:\s+\d+)?:?\s+((?:-?\d+(?:\.\d+)?\s*)+)", clean_output)
        
        if match:
            vector_str = match.group(1)
            try:
                vec = [float(x) for x in vector_str.split()]
                if len(vec) > 100:
                    return vec
            except ValueError:
                pass

        # Fallback: Just find the longest sequence of numbers anywhere in the output
        numbers = []
        current_chunk = []
        for token in clean_output.split():
            # Remove brackets if present
            token = token.strip("[],")
            try:
                val = float(token)
                current_chunk.append(val)
            except ValueError:
                if len(current_chunk) > 100:
                    numbers.append(current_chunk)
                current_chunk = []
        
        if len(current_chunk) > 100:
            numbers.append(current_chunk)
            
        if numbers:
            return max(numbers, key=len)

        raise RuntimeError(f"Could not parse embedding from output. Output sample: {output[:200]}...")

    except Exception as e:
        raise RuntimeError(f"Embedding failed: {e}")
# src/main.py
import os
import json
from pathlib import Path
from .pipeline import process_email
from .parse import iter_maildir
import traceback

MAILDIR = os.path.expanduser(os.getenv("SMARTMAIL_MAILDIR", "~/Projects/smart-mail/data/maildir"))
OUT = os.path.expanduser(os.getenv("SMARTMAIL_OUT", "~/.local/share/smartmail/output.json"))
NUM_EMAILS = 5 
def main():
    results = []
    for mail in iter_maildir(MAILDIR):
        # print(f"Processing {mail['path']}...", end="\r")
        path = mail["path"]
        try:
            r = process_email(path)
            results.append(r)
        except Exception as e:
            print(f"error processing {path}: {e}")
            traceback.print_exc()

    results.sort(key=lambda x: x.get("combined_score", 0), reverse=True)
    top5 = results[:NUM_EMAILS]
    os.makedirs(os.path.dirname(OUT), exist_ok=True)
    with open(OUT, "w") as fh:
        json.dump(top5, fh, indent=2)
    print(f"Wrote top {len(top5)} to {OUT}")

if __name__ == "__main__":
    main()
# src/parse.py
import os
import mailparser
from dateutil import parser as dateparser
from typing import Dict, Generator
from datetime import datetime

def iter_maildir(path: str) -> Generator[Dict, None, None]:
    """Yield parsed mails from a Maildir root (walks recursively)."""
    for root, _, files in os.walk(path):
        for f in files:
            if f.startswith("."): 
                continue
            fp = os.path.join(root, f)
            try:
                m = mailparser.parse_from_file(fp)
            except Exception:
                continue
            try:
                from_addr = m.from_[0][1] if m.from_ else ""
            except Exception:
                from_addr = ""
            body = ""
            if m.text_plain:
                body = "\n\n".join(m.text_plain)
            elif m.body:
                body = m.body
            attachments = []
            try:
                attachments = [att.get("filename", "") for att in m.attachments] if m.attachments else []
            except Exception:
                attachments = []
            raw_date = None
            try:
                raw_date = m.headers.get("date")
            except Exception:
                raw_date = None

            yield {
                "path": fp,
                "subject": m.subject or "",
                "from": from_addr,
                "date": normalize_date(raw_date),
                "body": body,
                "attachments": attachments,
            }
def normalize_date(d):
    if d is None:
        return None
    if isinstance(d, datetime):
        return d
    try:
        return dateparser.parse(d)
    except Exception:
        return None

def parse_mail_from_path(path: str) -> Dict:
    """Parse a single mail file path and return dict (same keys as iter_maildir yields)."""
    try:
        m = mailparser.parse_from_file(path)
    except Exception as e:
        raise RuntimeError(f"parse error {path}: {e}")
    try:
        from_addr = m.from_[0][1] if m.from_ else ""
    except Exception:
        from_addr = ""
    body = ""
    if m.text_plain:
        body = "\n\n".join(m.text_plain)
    elif m.body:
        body = m.body
    attachments = []
    try:
        attachments = [att.get("filename", "") for att in m.attachments] if m.attachments else []
    except Exception:
        attachments = []
    return {
        "path": path,
        "subject": m.subject or "",
        "from": from_addr,
        "date": normalize_date(m.date),
        "body": body,
        "attachments": attachments,
    }
# src/pipeline.py
from .parse import parse_mail_from_path
from .faiss_helper import FaissHelper
from .embed import embed_text
from .score import score_email
from .classify import rule_score
import math

faiss_helper = FaissHelper()

def process_email(path: str) -> dict:
    mail = parse_mail_from_path(path)
    text = (mail.get("subject") or "") + "\n\n" + (mail.get("body") or "")
    emb = embed_text(text)
    domains = faiss_helper.query(emb, k=3)
    domain = domains[0]["name"] if domains else "unknown"

    rscore = rule_score(mail)  # returns 0.0-1.0
    llm_out = score_email(mail.get("subject", ""), mail.get("body", ""), domain, mail.get("from", ""))
    llm_score = llm_out.get("importance", 10.0)

    combined = 0.7 * (rscore * 100.0) + 0.3 * llm_score
    combined = float(combined)

    return {
        "path": path,
        "subject": mail.get("subject", ""),
        "from": mail.get("from", ""),
        "date": str(mail.get("date", "")),
        "domain": domain,
        "domain_candidates": domains,
        "rule_score": rscore,
        "llm_score": llm_score,
        "combined_score": combined,
        "task": llm_out.get("task", ""),
        "reason": llm_out.get("reason", ""),
        "due": llm_out.get("due", None),
    }
import json
import re
from typing import Dict, Any, Optional
from .llama import call_llama

PROMPT_TEMPLATE = """You are a smart executive assistant. 
Your Goal: Identify important emails and ignore spam/noise.

RULES for Importance Scoring:
1.  **College/Clubs:** If the email is from a college tech team, student club, hackathon, or mass promotional recruitment, mark importance < 20 and task as "Archive".
2.  **Real Offers:** Only mark "Internship/Job" as HIGH importance (> 80) if it is a direct interview invite or an official offer letter addressed specifically to me.
3.  **General:** Promotional emails, newsletters, and automated notifications should be importance < 10.

Output ONLY valid JSON with these keys:
{{"importance": <number 0-100>, "task": "<one-line actionable task>", "reason": "<short reason>", "due": "<YYYY-MM-DD or null>"}}

Email Subject:
{subject}

Email Body:
{body}

Context: Domain: {domain}; From: {from_header}
"""

def _extract_last_json(s: str) -> Optional[Dict[str, Any]]:
    # fallback: simple conservative json extractor
    braces = []
    start = None
    for i, ch in enumerate(s):
        if ch == "{":
            if start is None:
                start = i
            braces.append(i)
        elif ch == "}":
            if braces:
                braces.pop()
                if not braces and start is not None:
                    candidate = s[start : i + 1]
                    try:
                        return json.loads(candidate)
                    except Exception:
                        # continue scanning
                        start = None
                        braces = []
    return None

def safe_extract_json(s: str) -> Optional[Dict[str, Any]]:
    # first try simple find
    try:
        m = re.findall(r"\{.*\}", s, re.S)
        if m:
            return json.loads(m[-1])
    except Exception:
        pass
    return _extract_last_json(s)

def score_email(subject: str, body: str, domain: str, from_header: str) -> Dict:
    # FIX: Truncate body to prevent exceeding context limits (approx 2000 chars)
    trunc_body = body[:2000] if body else ""
    trunc_subject = subject[:200] if subject else ""
    
    prompt = PROMPT_TEMPLATE.format(subject=trunc_subject, body=trunc_body, domain=domain, from_header=from_header)
    
    try:
        # Increased timeout slightly for safety
        out = call_llama(prompt, max_tokens=256, temperature=0.0, timeout=45)
    except Exception as e:
        return {"importance": 10.0, "task": "", "reason": f"LLM failure: {e}", "due": None}
    
    parsed = safe_extract_json(out)
    if parsed is None:
        # Return default if parsing fails
        return {"importance": 10.0, "task": "", "reason": "LLM produced unparsable output", "due": None}
        
    importance = parsed.get("importance", 10)
    try:
        importance = float(importance)
        importance = max(0.0, min(100.0, importance))
    except Exception:
        importance = 10.0
        
    return {
        "importance": importance,
        "task": parsed.get("task", "")[:512],
        "reason": parsed.get("reason", "")[:512],
        "due": parsed.get("due", None)
    }
